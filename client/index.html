<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/index.css" rel="stylesheet" />
    <title>SCORM Player MVP</title>
</head>
<body>
    <div class="container">
        <div class="main-header">
            <div>
                <h1>SCORM Player MVP</h1>
            </div>
            <div class="header-controls">
                <span id="user-display" style="color: #666; margin-right: 15px;"></span>
                <a href="admin.html" class="admin-link" id="admin-link" style="display: none;">üìä Admin Dashboard</a>
                <button onclick="logout()" class="admin-link" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Logout</button>
            </div>
        </div>
        
        <div class="upload-section" id="upload-section" style="display: none;">
            <p style="margin-bottom: 20px; color: #666;">Upload a SCORM package (ZIP file)</p>
            <label for="file-input" class="upload-btn">Choose File</label>
            <input type="file" id="file-input" accept=".zip">
            <div id="upload-status" class="status" style="display: none; margin-top: 20px;"></div>
        </div>
        
        <div id="courses-section">
            <h2 style="color: #333; margin-bottom: 20px;">Available Courses</h2>
            <div id="courses-grid" class="courses-grid"></div>
        </div>
    </div>
    
    <div id="player-modal">
        <div class="player-container">
            <div class="player-header">
                <span id="player-title">Course Player</span>
                <button class="close-btn" onclick="closePlayer()">&times;</button>
            </div>
            <iframe id="content-frame"></iframe>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <h2>Delete Course</h2>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this course?</p>
                <p class="course-name-display" id="deleteCourseTitle"></p>
                <p class="warning-text">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button id="cancelDelete" class="btn-cancel">Cancel</button>
                <button id="confirmDelete" class="btn-delete">Delete Course</button>
            </div>
        </div>
    </div>
    
    <script src="/js/scorm-api.js"></script>
    <script>
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000' 
            : 'https://dev.orthoskool.com';

        let courses = [];
        let courseToDelete = null;
        let token = null;
        let currentUser = null;
        
        // Check authentication on page load
        window.onload = async function() {
            token = localStorage.getItem('accessToken');
            const userStr = localStorage.getItem('user');
            
            if (!token || !userStr) {
                window.location.href = '/login.html';
                return;
            }

            currentUser = JSON.parse(userStr);
            
            // Display user info
            document.getElementById('user-display').textContent = `üë§ ${currentUser.name}`;
            
            // Show admin features if user is admin
            if (currentUser.role === 'admin') {
                document.getElementById('admin-link').style.display = 'inline-block';
                document.getElementById('upload-section').style.display = 'block';
            }

            await loadCourses();
        };

        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };

            const response = await fetch(API_URL + url, { ...defaultOptions, ...options });
            
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('accessToken');
                localStorage.removeItem('user');
                window.location.href = '/login.html';
                throw new Error('Authentication failed');
            }

            return response.json();
        }
        
        // File upload handler
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                uploadCourse(file);
            }
        });
        
        function uploadCourse(file) {
            const formData = new FormData();
            formData.append('scormPackage', file);
            
            const status = document.getElementById('upload-status');
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            status.innerHTML = `
                <div>Uploading ${file.name} (${fileSize} MB)...</div>
                <div style="margin-top: 10px;">
                    <progress id="upload-progress" max="100" value="0" style="width: 100%;"></progress>
                    <span id="progress-text">0%</span>
                </div>
            `;
            status.className = 'status';
            status.style.display = 'block';
            
            const xhr = new XMLHttpRequest();
            
            // Track upload progress
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    document.getElementById('upload-progress').value = percentComplete;
                    document.getElementById('progress-text').textContent = Math.round(percentComplete) + '%';
                }
            });
            
            xhr.addEventListener('load', () => {
                if (xhr.status === 200) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (data.success) {
                            status.textContent = 'Course uploaded successfully!';
                            status.className = 'status success';
                            loadCourses();
                            document.getElementById('file-input').value = '';
                        } else {
                            throw new Error(data.error || 'Upload failed');
                        }
                    } catch (error) {
                        status.textContent = 'Error: ' + error.message;
                        status.className = 'status error';
                    }
                } else if (xhr.status === 401 || xhr.status === 403) {
                    status.textContent = 'Error: Authentication failed. Please login again.';
                    status.className = 'status error';
                    setTimeout(() => {
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('user');
                        window.location.href = '/login.html';
                    }, 2000);
                } else {
                    status.textContent = 'Error: Upload failed (Status ' + xhr.status + ')';
                    status.className = 'status error';
                }
            });
            
            xhr.addEventListener('error', () => {
                status.textContent = 'Error: Network error during upload';
                status.className = 'status error';
            });
            
            xhr.addEventListener('timeout', () => {
                status.textContent = 'Error: Upload timed out';
                status.className = 'status error';
            });
            
            xhr.open('POST', API_URL + '/api/courses/upload');
            xhr.setRequestHeader('Authorization', `Bearer ${token}`);
            xhr.timeout = 300000; // 5 minute timeout
            xhr.send(formData);
        }
        
        async function loadCourses() {
            try {
                courses = await apiRequest('/api/courses');
                displayCourses();
            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }
        
        function displayCourses() {
            const grid = document.getElementById('courses-grid');
            grid.innerHTML = '';
            
            if (courses.length === 0) {
                grid.innerHTML = '<p style="color: #666;">No courses available. Upload a SCORM package to get started.</p>';
                return;
            }
            
            courses.forEach(course => {
                const card = document.createElement('div');
                card.className = 'course-card';
                
                const deleteButton = currentUser.role === 'admin' 
                    ? `<button class="delete-btn" onclick="showDeleteModal('${course.id}', '${course.title.replace(/'/g, "\\'")}')">√ó</button>`
                    : '';
                
                card.innerHTML = `
                    <div class="course-title">${course.title}</div>
                    <div class="course-meta">
                        Uploaded: ${new Date(course.uploadedAt).toLocaleDateString()}
                    </div>
                    <div class="button-group">
                        <button class="launch-btn" onclick="launchCourse('${course.id}', '${course.title}')">
                            Launch Course
                        </button>
                        ${deleteButton}
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        function launchCourse(courseId, title) {
            window.location.href = `player.html?courseId=${courseId}&title=${encodeURIComponent(title)}&userId=${currentUser.id}`;
        }
        
        function showDeleteModal(courseId, courseTitle) {
            courseToDelete = courseId;
            document.getElementById('deleteCourseTitle').textContent = courseTitle;
            document.getElementById('deleteModal').classList.add('show');
        }
        
        // Modal event listeners
        document.getElementById('cancelDelete').addEventListener('click', () => {
            document.getElementById('deleteModal').classList.remove('show');
            courseToDelete = null;
        });

        document.getElementById('confirmDelete').addEventListener('click', async () => {
            if (!courseToDelete) return;

            try {
                const response = await fetch(API_URL + `/api/courses/${courseToDelete}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('deleteModal').classList.remove('show');
                    courseToDelete = null;
                    loadCourses();
                } else {
                    alert('Error deleting course: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting course: ' + error.message);
            }
        });

        // Close modal when clicking outside
        document.getElementById('deleteModal').addEventListener('click', (e) => {
            if (e.target.id === 'deleteModal') {
                document.getElementById('deleteModal').classList.remove('show');
                courseToDelete = null;
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.getElementById('deleteModal').classList.remove('show');
                courseToDelete = null;
            }
        });
        
        function closePlayer() {
            // Call LMSFinish if course is active
            if (window.API.courseId) {
                window.API.LMSFinish('');
            }
            
            document.getElementById('player-modal').style.display = 'none';
            document.getElementById('content-frame').src = '';
            window.API.courseId = null;
        }
        
        function logout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        }

        // Drag and drop functionality (admin only)
        if (currentUser && currentUser.role === 'admin') {
            const uploadSection = document.querySelector('.upload-section');

            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.style.borderColor = '#007bff';
                uploadSection.style.backgroundColor = '#e7f3ff';
            });

            uploadSection.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadSection.style.borderColor = '#ddd';
                uploadSection.style.backgroundColor = '#f8f9fa';
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.style.borderColor = '#ddd';
                uploadSection.style.backgroundColor = '#f8f9fa';
                
                const file = e.dataTransfer.files[0];
                if (file && file.name.endsWith('.zip')) {
                    uploadCourse(file);
                }
            });
        }
    </script>
</body>
</html>